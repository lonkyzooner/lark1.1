<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LARK LiveKit</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #001a3a;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            width: 240px;
            height: 240px;
            position: relative;
            overflow: hidden;
        }
        
        .header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 30px;
            background-color: #000c1a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            box-sizing: border-box;
        }
        
        .title {
            font-weight: bold;
            font-size: 14px;
        }
        
        .connection {
            display: flex;
            align-items: center;
            font-size: 12px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .connected {
            background-color: #00cc00;
        }
        
        .disconnected {
            background-color: #cc0000;
        }
        
        .main-circle {
            position: absolute;
            top: 70px;
            left: 70px;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid #0055aa;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background-color: #001a3a;
        }
        
        .main-circle.listening {
            border-color: #00cc00;
        }
        
        .main-circle.speaking {
            border-color: #cc00cc;
        }
        
        .status-text {
            position: absolute;
            bottom: 40px;
            width: 100%;
            text-align: center;
            font-size: 14px;
        }
        
        .button {
            position: absolute;
            bottom: 10px;
            width: 120px;
            height: 25px;
            background-color: #0055aa;
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            left: 60px;
        }
        
        .button:active {
            background-color: #003c77;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">LARK v1.4</div>
            <div class="connection">
                <div id="connectionIndicator" class="status-indicator disconnected"></div>
                <span id="connectionStatus">Offline</span>
            </div>
        </div>
        
        <div id="mainCircle" class="main-circle">
            <div>LARK</div>
            <div id="circleStatus">Ready</div>
        </div>
        
        <div id="statusText" class="status-text">Say "Hey LARK" to begin</div>
        
        <button id="activateButton" class="button">Activate LARK</button>
    </div>

    <!-- LiveKit SDK -->
    <script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>
    
    <script>
        // LiveKit configuration
        const LIVEKIT_URL = 'wss://your-livekit-server.com';  // Replace with your LiveKit server
        const ROOM_NAME = 'lark-room';
        const TOKEN = '';  // Will be generated or provided
        
        // State tracking
        let isListening = false;
        let isSpeaking = false;
        let isConnected = false;
        
        // DOM elements
        const mainCircle = document.getElementById('mainCircle');
        const circleStatus = document.getElementById('circleStatus');
        const statusText = document.getElementById('statusText');
        const activateButton = document.getElementById('activateButton');
        const connectionIndicator = document.getElementById('connectionIndicator');
        const connectionStatus = document.getElementById('connectionStatus');
        
        // LiveKit room
        let room = null;
        
        // SimplePeer for WebRTC fallback
        let peerConnection = null;
        
        // Set up audio context for audio processing
        let audioContext = null;
        let audioAnalyser = null;
        let audioDataArray = null;
        
        // Initialize audio context
        function initAudioContext() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioAnalyser = audioContext.createAnalyser();
                audioAnalyser.fftSize = 256;
                const bufferLength = audioAnalyser.frequencyBinCount;
                audioDataArray = new Uint8Array(bufferLength);
                return true;
            } catch (error) {
                console.error('Error initializing audio context:', error);
                return false;
            }
        }
        
        // Check if microphone permission is granted
        async function checkMicrophonePermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (error) {
                console.error('Microphone permission denied:', error);
                return false;
            }
        }
        
        // Connect to LiveKit
        async function connectToLiveKit() {
            try {
                if (!TOKEN) {
                    // In a real implementation, you would generate a token here
                    // or fetch it from your server
                    console.error('No token available');
                    updateConnectionStatus(false);
                    return false;
                }
                
                // Create and connect to room
                room = new LivekitClient.Room();
                
                // Set up event listeners
                room.on(LivekitClient.RoomEvent.Connected, () => {
                    console.log('Connected to LiveKit room');
                    updateConnectionStatus(true);
                });
                
                room.on(LivekitClient.RoomEvent.Disconnected, () => {
                    console.log('Disconnected from LiveKit room');
                    updateConnectionStatus(false);
                });
                
                room.on(LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
                    if (track.kind === 'audio') {
                        // Handle incoming audio
                        handleIncomingAudio(track);
                    }
                });
                
                // Connect to room
                await room.connect(LIVEKIT_URL, TOKEN);
                
                // Publish local audio
                const localTrack = await LivekitClient.createLocalAudioTrack();
                await room.localParticipant.publishTrack(localTrack);
                
                return true;
            } catch (error) {
                console.error('Error connecting to LiveKit:', error);
                updateConnectionStatus(false);
                return false;
            }
        }
        
        // Handle incoming audio
        function handleIncomingAudio(track) {
            const audioElement = new Audio();
            audioElement.srcObject = new MediaStream([track.mediaStreamTrack]);
            audioElement.play();
            
            // When audio starts playing
            audioElement.onplaying = () => {
                setLARKSpeaking(true);
            };
            
            // When audio ends
            audioElement.onended = () => {
                setLARKSpeaking(false);
            };
        }
        
        // Update connection status UI
        function updateConnectionStatus(connected) {
            isConnected = connected;
            if (connected) {
                connectionIndicator.classList.remove('disconnected');
                connectionIndicator.classList.add('connected');
                connectionStatus.textContent = 'Online';
            } else {
                connectionIndicator.classList.remove('connected');
                connectionIndicator.classList.add('disconnected');
                connectionStatus.textContent = 'Offline';
            }
        }
        
        // Set LARK listening state
        function setLARKListening(listening) {
            isListening = listening;
            if (listening) {
                mainCircle.classList.remove('speaking');
                mainCircle.classList.add('listening');
                circleStatus.textContent = 'Listening';
                statusText.textContent = 'Listening...';
            } else {
                mainCircle.classList.remove('listening');
                circleStatus.textContent = 'Ready';
                statusText.textContent = 'Say "Hey LARK" to begin';
            }
        }
        
        // Set LARK speaking state
        function setLARKSpeaking(speaking) {
            isSpeaking = speaking;
            if (speaking) {
                mainCircle.classList.remove('listening');
                mainCircle.classList.add('speaking');
                circleStatus.textContent = 'Speaking';
                statusText.textContent = 'LARK is responding...';
            } else {
                mainCircle.classList.remove('speaking');
                circleStatus.textContent = 'Ready';
                statusText.textContent = 'Say "Hey LARK" to begin';
            }
        }
        
        // Activate LARK
        async function activateLARK() {
            // Initialize audio context if not already done
            if (!audioContext) {
                const initialized = initAudioContext();
                if (!initialized) {
                    statusText.textContent = 'Error initializing audio';
                    return;
                }
            }
            
            // Check microphone permission
            const hasMicPermission = await checkMicrophonePermission();
            if (!hasMicPermission) {
                statusText.textContent = 'Microphone access denied';
                return;
            }
            
            // Connect to LiveKit if not connected
            if (!isConnected) {
                statusText.textContent = 'Connecting...';
                const connected = await connectToLiveKit();
                if (!connected) {
                    statusText.textContent = 'Connection failed';
                    return;
                }
            }
            
            // Start listening
            setLARKListening(true);
            
            // In a real implementation, this would be handled by the LiveKit audio processing
            // For demonstration, we'll simulate a response after 3 seconds
            setTimeout(() => {
                setLARKListening(false);
                setLARKSpeaking(true);
                
                // Simulate end of speaking after 5 seconds
                setTimeout(() => {
                    setLARKSpeaking(false);
                }, 5000);
            }, 3000);
        }
        
        // Event listeners
        activateButton.addEventListener('click', activateLARK);
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check network status
            updateConnectionStatus(navigator.onLine);
            
            // Update status based on network changes
            window.addEventListener('online', () => updateConnectionStatus(true));
            window.addEventListener('offline', () => updateConnectionStatus(false));
        });
    </script>
</body>
</html>
